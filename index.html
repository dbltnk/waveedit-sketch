<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMOD Music Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }

        /* Main App Layout */
        .app {
            display: flex;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Title Bar */
        .title-bar {
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }

        .waveedit .title-bar {
            background: linear-gradient(90deg, #8e44ad, #9b59b6);
        }

        .title-text {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .window-controls {
            display: flex;
            gap: 10px;
        }

        .window-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .minimize {
            background: #f39c12;
        }

        .maximize {
            background: #27ae60;
        }

        .close {
            background: #e74c3c;
        }

        /* Menu Bar */
        .menu-bar {
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background: #2c2c2c;
            border-bottom: 1px solid #444;
            gap: 20px;
            flex-shrink: 0;
        }

        .menu-item {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #404040;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Left Panel (Tools for WaveEdit) */
        .left-panel {
            width: 200px;
            background: #2a2a2a;
            border-right: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .plugin-section {
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            background: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .plugin-section:hover:not(.disabled) {
            background: #404040;
            border-color: #9b59b6;
        }

        .plugin-section.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .plugin-section.active {
            border-color: #9b59b6;
            background: #443355;
        }

        .plugin-section.active .plugin-title {
            color: #9b59b6;
        }

        .plugin-section.active .checkbox {
            background: #9b59b6;
            border-color: #9b59b6;
        }

        .plugin-section.active .checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            line-height: 1;
        }

        .plugin-section.disabled .checkbox {
            opacity: 0.3;
            pointer-events: none;
        }

        .plugin-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Center Panel */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            overflow: hidden;
            position: relative;
        }

        /* Transport Controls */
        .transport-controls {
            height: 60px;
            background: #252525;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            flex-shrink: 0;
        }

        .transport-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 5px;
            background: #404040;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .transport-btn:hover {
            background: #505050;
        }

        .time-display {
            margin-left: auto;
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            padding: 8px 15px;
            border-radius: 5px;
        }

        /* Timeline */
        .timeline-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        .timeline-ruler {
            height: 30px;
            background: #2a2a2a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 3px;
        }

        .time-marker {
            margin-right: 40px;
            font-size: 12px;
            color: #aaa;
        }

        /* Merged View */
        .merged-view {
            height: 240px;
            /* Increased from 80px to 240px */
            background: #333;
            margin-bottom: 20px;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .merged-view::before {
            content: "MERGED VIEW";
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 12px;
            color: #aaa;
            z-index: 20;
        }

        /* Track layer in merged view */
        #merged.track-layer {
            height: 240px !important;
            /* Match merged view height */
        }

        /* Track content in merged view */
        #merged .track-content {
            height: 240px !important;
            /* Match merged view height */
            background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%);
            position: relative;
        }

        .merged-waveform {
            position: absolute;
            bottom: 5px;
            left: 10px;
            right: 30px;
            height: 15px;
            border-radius: 2px;
            opacity: 0.8;
        }

        .merged-waveform.layer-1 {
            background: linear-gradient(90deg, #8e44ad 0%, #8e44ad 15%, transparent 15%, transparent 25%, #8e44ad 25%, #8e44ad 40%, transparent 40%, transparent 100%);
            bottom: 15px;
        }

        .merged-waveform.layer-2 {
            background: linear-gradient(90deg, transparent 0%, transparent 20%, #9b59b6 20%, #9b59b6 35%, transparent 35%, transparent 60%, #9b59b6 60%, #9b59b6 75%, transparent 75%, transparent 100%);
            bottom: 25px;
        }

        .merged-waveform.layer-3 {
            background: linear-gradient(90deg, #e74c3c 0%, #e74c3c 10%, transparent 10%, transparent 45%, #e74c3c 45%, #e74c3c 55%, transparent 55%, transparent 80%, #e74c3c 80%, #e74c3c 90%, transparent 90%, transparent 100%);
            bottom: 35px;
        }

        .merged-waveform.layer-4 {
            background: repeating-linear-gradient(90deg, #555 0px, #666 2px, #555 2px, #666 4px);
            bottom: 45px;
            opacity: 0.4;
        }

        /* Track Layers */
        .track-layer {
            height: 60px;
            background: #2a2a2a;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: relative;
        }

        .track-info {
            width: 150px;
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 4px 0;
            line-height: 0.6;
        }

        .track-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
            margin-right: 10px;
        }

        .track-content {
            flex: 1;
            height: 30px;
            margin-left: 20px;
            position: relative;
            background: #1a1a1a;
            border-radius: 3px;
        }

        /* Analyze button overlay */
        .analyze-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .analyze-btn {
            padding: 8px 16px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .analyze-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Analysis minigame styles */
        .track-layer:not(#merged) {
            display: none;
        }

        .analysis-clip {
            position: absolute;
            height: 20px;
            top: 20px;
            border-radius: 3px;
            cursor: pointer;
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
            user-select: none;
            transition: all 0.2s ease;
            z-index: 20;
            background: #444;
            pointer-events: none;
        }

        .analysis-clip.revealed {
            animation: reveal 0.5s ease-out;
        }

        @keyframes reveal {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #1abc9c;
            background: rgba(26, 188, 156, 0.1);
            pointer-events: none;
            z-index: 30;
        }

        .selection-box.invalid {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        /* Audio clip styling */
        .audio-clip {
            position: absolute;
            height: 20px;
            top: 5px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
            user-select: none;
            transition: all 0.2s ease;
            background: transparent;
            overflow: hidden;
            font-style: normal !important;
            /* Prevent italic */
            z-index: 5;
            /* Base layer for clip */
        }

        /* Clip effect icons container */
        .clip-effects-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 12px;
            z-index: 1;
            /* Below text */
            pointer-events: none;
        }

        /* Clip effect icons */
        .clip-effect {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
            line-height: 1;
            font-style: normal !important;
            /* Prevent italic */
        }

        /* Ensure text is always on top */
        .audio-clip::after {
            content: attr(data-clip);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            /* Above everything */
            font-style: normal !important;
            /* Prevent italic */
        }

        /* Hide the original text content */
        .audio-clip {
            color: transparent;
        }

        .clip-effect+.clip-effect {
            left: 14px;
        }

        .clip-effect+.clip-effect+.clip-effect {
            left: 26px;
        }

        .clip-effect+.clip-effect+.clip-effect+.clip-effect {
            left: 38px;
        }

        /* Hide effect icons in merged view */
        #merged .clip-effects-container {
            display: none;
        }

        /* Add styles for merged view clips */
        #merged .audio-clip {
            pointer-events: none !important;
            opacity: 0.5;
            z-index: 1;
            height: 18px;
            top: 0;
            /* Reset top position, will be set by JS */
            cursor: default;
        }

        #merged .audio-clip.revealed {
            opacity: 0.7;
            z-index: 2;
            pointer-events: none !important;
        }

        /* Layer-specific colors for merged view */
        #merged .audio-clip[data-layer="evidence-recording"] {
            color: #e74c3c;
        }

        #merged .audio-clip[data-layer="ghost-voices"] {
            color: #8e44ad;
        }

        #merged .audio-clip[data-layer="investigation"] {
            color: #27ae60;
        }

        #merged .audio-clip[data-layer="ambient-static-wave"] {
            color: #34495e;
        }

        .audio-clip::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(90deg,
                    transparent 0px,
                    transparent 2px,
                    currentColor 2px,
                    currentColor 4px,
                    transparent 4px,
                    transparent 6px,
                    currentColor 6px,
                    currentColor 8px,
                    transparent 8px,
                    transparent 10px,
                    currentColor 10px,
                    currentColor 12px,
                    transparent 12px,
                    transparent 14px,
                    currentColor 14px,
                    currentColor 16px,
                    transparent 16px,
                    transparent 18px,
                    currentColor 18px,
                    currentColor 20px,
                    transparent 20px,
                    transparent 22px,
                    currentColor 22px,
                    currentColor 24px,
                    transparent 24px,
                    transparent 26px,
                    currentColor 26px,
                    currentColor 28px,
                    transparent 28px,
                    transparent 30px,
                    currentColor 30px,
                    currentColor 32px,
                    transparent 32px,
                    transparent 34px,
                    currentColor 34px,
                    currentColor 36px,
                    transparent 36px,
                    transparent 38px,
                    currentColor 38px,
                    currentColor 40px,
                    transparent 40px,
                    transparent 42px,
                    currentColor 42px,
                    currentColor 44px,
                    transparent 44px,
                    transparent 46px,
                    currentColor 46px,
                    currentColor 48px,
                    transparent 48px,
                    transparent 50px,
                    currentColor 50px,
                    currentColor 52px,
                    transparent 52px,
                    transparent 54px,
                    currentColor 54px,
                    currentColor 56px,
                    transparent 56px,
                    transparent 58px,
                    currentColor 58px,
                    currentColor 60px,
                    transparent 60px,
                    transparent 62px,
                    currentColor 62px,
                    currentColor 64px,
                    transparent 64px,
                    transparent 66px,
                    currentColor 66px,
                    currentColor 68px,
                    transparent 68px,
                    transparent 70px,
                    currentColor 70px,
                    currentColor 72px,
                    transparent 72px,
                    transparent 74px,
                    currentColor 74px,
                    currentColor 76px,
                    transparent 76px,
                    transparent 78px,
                    currentColor 78px,
                    currentColor 80px,
                    transparent 80px,
                    transparent 82px,
                    currentColor 82px,
                    currentColor 84px,
                    transparent 84px,
                    transparent 86px,
                    currentColor 86px,
                    currentColor 88px,
                    transparent 88px,
                    transparent 90px,
                    currentColor 90px,
                    currentColor 92px,
                    transparent 92px,
                    transparent 94px,
                    currentColor 94px,
                    currentColor 96px,
                    transparent 96px,
                    transparent 98px,
                    currentColor 98px,
                    currentColor 100px,
                    transparent 100px);
            opacity: 0.3;
            z-index: 0;
        }

        .audio-clip:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .audio-clip.selected {
            border: 2px solid #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.3);
        }

        .audio-clip.dragging {
            z-index: 1000;
            transform: rotate(5deg);
            opacity: 0.8;
        }

        .audio-clip.disabled {
            opacity: 0.3;
            filter: grayscale(100%);
            pointer-events: none;
        }

        /* Layer-specific colors */
        #evidence-recording .audio-clip {
            color: #e74c3c;
        }

        #ghost-voices .audio-clip {
            color: #8e44ad;
        }

        #investigation .audio-clip {
            color: #27ae60;
        }

        #ambient-static-wave .audio-clip {
            color: #34495e;
        }

        /* Plugin applied effects */
        .clip-volume-boost {
            border-top: 2px solid #1abc9c;
        }

        .clip-denoise {
            opacity: 0.8;
            border-top: 2px solid #95a5a6;
        }

        .clip-frequency {
            border-top: 2px solid #3498db;
        }

        .clip-speed {
            font-style: italic;
            border-top: 2px solid #e67e22;
        }

        .clip-volume-boost::before {
            content: 'üîä';
            position: absolute;
            top: -12px;
            left: 2px;
            font-size: 8px;
        }

        .clip-denoise::before {
            content: 'üå´';
            position: absolute;
            top: -12px;
            left: 2px;
            font-size: 8px;
        }

        .clip-frequency::before {
            content: 'üìä';
            position: absolute;
            top: -12px;
            left: 2px;
            font-size: 8px;
        }

        .clip-speed::before {
            content: '‚ö°';
            position: absolute;
            top: -12px;
            left: 2px;
            font-size: 8px;
        }

        /* Track states */
        .track-muted {
            opacity: 0.4;
        }

        .track-soloed {
            box-shadow: 0 0 5px #f39c12;
        }

        .track-stereo .track-content {
            height: 50px;
        }

        .track-stereo .track-content::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            height: 18px;
            background: inherit;
            opacity: 0.6;
            border-radius: 3px;
        }

        /* Drag and drop zones */
        .drop-zone {
            min-height: 30px;
            border: 2px dashed transparent;
            margin: 2px 0;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #1abc9c;
            background: rgba(26, 188, 156, 0.1);
        }

        /* Audio control buttons */
        .audio-control {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
            font-size: 12px;
            border: 1px solid transparent;
        }

        .audio-control:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .audio-control.active {
            background: rgba(243, 156, 18, 0.3);
            border-color: #f39c12;
        }

        .audio-control.muted {
            color: #e74c3c;
        }

        .audio-control.soloed {
            color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        /* Color themes */
        .waveedit .track-layer {
            border-left: 3px solid #9b59b6;
        }

        .waveedit .transport-controls {
            border-bottom-color: #9b59b6;
        }

        /* Tools Panel States */
        .tools-message {
            color: #888;
            font-size: 14px;
            text-align: center;
            padding: 20px;
            font-style: italic;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
        }

        .tools-container {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        /* Right Panel (Tools for WaveEdit) */
        .right-panel {
            width: 200px;
            background: #2a2a2a;
            border-left: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .tools-header {
            font-size: 16px;
            font-weight: bold;
            color: #ecf0f1;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            text-align: center;
        }

        /* Clip effect icons */
        .clip-effect {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            z-index: 10;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
            line-height: 1;
        }

        .clip-effect+.clip-effect {
            left: 14px;
        }

        .clip-effect+.clip-effect+.clip-effect {
            left: 26px;
        }

        .clip-effect+.clip-effect+.clip-effect+.clip-effect {
            left: 38px;
        }

        /* Hide effect icons in merged view */
        #merged .clip-effect {
            display: none;
        }

        /* Selected Clip Display */
        .selected-clip-display {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .selected-clip-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .selected-clip-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ecf0f1;
            font-size: 14px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .selected-clip-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .selected-clip-play-btn,
        .selected-clip-stop-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #9b59b6;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .selected-clip-play-btn:hover,
        .selected-clip-stop-btn:hover {
            background: #8e44ad;
            transform: scale(1.1);
        }

        .selected-clip-stop-btn {
            background: #e74c3c;
        }

        .selected-clip-stop-btn:hover {
            background: #c0392b;
        }

        .selected-clip-time {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #888;
        }

        .selected-clip-waveform {
            height: 20px;
            background: #333;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
        }

        .selected-clip-waveform::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%, transparent 1%,
                    currentColor 1%, currentColor 2%,
                    transparent 2%, transparent 3%,
                    currentColor 3%, currentColor 4%,
                    transparent 4%, transparent 5%,
                    currentColor 5%, currentColor 6%,
                    transparent 6%, transparent 7%,
                    currentColor 7%, currentColor 8%,
                    transparent 8%, transparent 9%,
                    currentColor 9%, currentColor 10%,
                    transparent 10%, transparent 11%,
                    currentColor 11%, currentColor 12%,
                    transparent 12%, transparent 13%,
                    currentColor 13%, currentColor 14%,
                    transparent 14%, transparent 15%,
                    currentColor 15%, currentColor 16%,
                    transparent 16%, transparent 17%,
                    currentColor 17%, currentColor 18%,
                    transparent 18%, transparent 19%,
                    currentColor 19%, currentColor 20%,
                    transparent 20%, transparent 21%,
                    currentColor 21%, currentColor 22%,
                    transparent 22%, transparent 23%,
                    currentColor 23%, currentColor 24%,
                    transparent 24%, transparent 25%,
                    currentColor 25%, currentColor 26%,
                    transparent 26%, transparent 27%,
                    currentColor 27%, currentColor 28%,
                    transparent 28%, transparent 29%,
                    currentColor 29%, currentColor 30%,
                    transparent 30%, transparent 31%,
                    currentColor 31%, currentColor 32%,
                    transparent 32%, transparent 33%,
                    currentColor 33%, currentColor 34%,
                    transparent 34%, transparent 35%,
                    currentColor 35%, currentColor 36%,
                    transparent 36%, transparent 37%,
                    currentColor 37%, currentColor 38%,
                    transparent 38%, transparent 39%,
                    currentColor 39%, currentColor 40%,
                    transparent 40%, transparent 41%,
                    currentColor 41%, currentColor 42%,
                    transparent 42%, transparent 43%,
                    currentColor 43%, currentColor 44%,
                    transparent 44%, transparent 45%,
                    currentColor 45%, currentColor 46%,
                    transparent 46%, transparent 47%,
                    currentColor 47%, currentColor 48%,
                    transparent 48%, transparent 49%,
                    currentColor 49%, currentColor 50%,
                    transparent 50%, transparent 51%,
                    currentColor 51%, currentColor 52%,
                    transparent 52%, transparent 53%,
                    currentColor 53%, currentColor 54%,
                    transparent 54%, transparent 55%,
                    currentColor 55%, currentColor 56%,
                    transparent 56%, transparent 57%,
                    currentColor 57%, currentColor 58%,
                    transparent 58%, transparent 59%,
                    currentColor 59%, currentColor 60%,
                    transparent 60%, transparent 61%,
                    currentColor 61%, currentColor 62%,
                    transparent 62%, transparent 63%,
                    currentColor 63%, currentColor 64%,
                    transparent 64%, transparent 65%,
                    currentColor 65%, currentColor 66%,
                    transparent 66%, transparent 67%,
                    currentColor 67%, currentColor 68%,
                    transparent 68%, transparent 69%,
                    currentColor 69%, currentColor 70%,
                    transparent 70%, transparent 71%,
                    currentColor 71%, currentColor 72%,
                    transparent 72%, transparent 73%,
                    currentColor 73%, currentColor 74%,
                    transparent 74%, transparent 75%,
                    currentColor 75%, currentColor 76%,
                    transparent 76%, transparent 77%,
                    currentColor 77%, currentColor 78%,
                    transparent 78%, transparent 79%,
                    currentColor 79%, currentColor 80%,
                    transparent 80%, transparent 81%,
                    currentColor 81%, currentColor 82%,
                    transparent 82%, transparent 83%,
                    currentColor 83%, currentColor 84%,
                    transparent 84%, transparent 85%,
                    currentColor 85%, currentColor 86%,
                    transparent 86%, transparent 87%,
                    currentColor 87%, currentColor 88%,
                    transparent 88%, transparent 89%,
                    currentColor 89%, currentColor 90%,
                    transparent 90%, transparent 91%,
                    currentColor 91%, currentColor 92%,
                    transparent 92%, transparent 93%,
                    currentColor 93%, currentColor 94%,
                    transparent 94%, transparent 95%,
                    currentColor 95%, currentColor 96%,
                    transparent 96%, transparent 97%,
                    currentColor 97%, currentColor 98%,
                    transparent 98%, transparent 99%,
                    currentColor 99%, currentColor 100%);
            opacity: 0.7;
        }

        /* Add slider styles */
        .slider-container {
            margin: 8px 0;
            position: relative;
            height: 20px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
            margin-bottom: 4px;
        }

        .slider-track {
            position: relative;
            height: 4px;
            background: #444;
            border-radius: 2px;
            margin: 8px 0;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background: #9b59b6;
            border-radius: 2px;
            width: 50%;
            /* Start at center */
            transition: width 0.1s ease;
        }

        .slider-thumb {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid #9b59b6;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .slider-thumb:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .plugin-section.disabled .slider-track,
        .plugin-section.disabled .slider-thumb {
            opacity: 0.3;
            pointer-events: none;
        }

        .plugin-section.disabled .slider-labels {
            opacity: 0.3;
        }

        /* Ensure other track layers maintain their original height */
        .track-layer:not(#merged) {
            height: 60px !important;
        }

        .track-layer:not(#merged) .track-content {
            height: 30px !important;
        }
    </style>
</head>

<body>
    <!-- Landing Screen -->
    <!-- Removed landing screen div -->

    <!-- Assembly App -->
    <!-- Removed Assembly app div -->

    <!-- WaveEdit App -->
    <div id="waveedit" class="app waveedit active">
        <div class="title-bar">
            <div class="title-text">
                ‚öô FMOD Music - WaveEdit
            </div>
            <div class="window-controls">
                <button class="window-btn minimize">‚àí</button>
                <button class="window-btn maximize">‚ñ°</button>
                <button class="window-btn close">‚úï</button>
            </div>
        </div>

        <div class="menu-bar">
            <span class="menu-item">Load</span>
            <span class="menu-item">Save</span>
            <span class="menu-item" onclick="autoAnalyzeAll()">Analyze</span>
            <span class="menu-item">Details</span>
            <span class="menu-item">Plugins</span>
            <span class="menu-item">Help</span>
            <span class="menu-item">License</span>
        </div>

        <div class="main-content">
            <div class="center-panel">
                <div class="transport-controls">
                    <button class="transport-btn" onclick="toggleMainPlayback(event)">‚ñ∂</button>
                    <button class="transport-btn" onclick="stopMainPlayback(event)">‚èπ</button>
                    <button class="transport-btn" onclick="seekToStart(event)">‚èÆ</button>
                    <button class="transport-btn" onclick="seekToEnd(event)">‚è≠</button>
                    <div class="time-display">00:00.000 / 00:47.000</div>
                </div>

                <div class="track-layer" id="merged">
                    <div class="track-info">
                        <span style="font-size: 0.8em; color: #95a5a6;">crime_scene.wav</span><br>
                        <span style="font-weight: bold; color: #ecf0f1;">All Layers</span>
                    </div>
                    <div class="track-content"
                        style="background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%); position: relative; height: 60px;"
                        onclick="selectClip(event)">
                        <!-- Waveform visualization -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: 
                            linear-gradient(90deg,
                                #34495e 0%, #34495e 1%,
                                #2c3e50 1%, #2c3e50 2%,
                                #3498db 2%, #3498db 3%,
                                #2980b9 3%, #2980b9 4%,
                                #1abc9c 4%, #1abc9c 5%,
                                #16a085 5%, #16a085 6%,
                                #e74c3c 6%, #e74c3c 7%,
                                #c0392b 7%, #c0392b 8%,
                                #f1c40f 8%, #f1c40f 9%,
                                #f39c12 9%, #f39c12 10%,
                                #e67e22 10%, #e67e22 11%,
                                #d35400 11%, #d35400 12%,
                                #9b59b6 12%, #9b59b6 13%,
                                #8e44ad 13%, #8e44ad 14%,
                                #34495e 14%, #34495e 15%,
                                #2c3e50 15%, #2c3e50 16%,
                                #3498db 16%, #3498db 17%,
                                #2980b9 17%, #2980b9 18%,
                                #1abc9c 18%, #1abc9c 19%,
                                #16a085 19%, #16a085 20%,
                                #e74c3c 20%, #e74c3c 21%,
                                #c0392b 21%, #c0392b 22%,
                                #f1c40f 22%, #f1c40f 23%,
                                #f39c12 23%, #f39c12 24%,
                                #e67e22 24%, #e67e22 25%,
                                #d35400 25%, #d35400 26%,
                                #9b59b6 26%, #9b59b6 27%,
                                #8e44ad 27%, #8e44ad 28%,
                                #34495e 28%, #34495e 29%,
                                #2c3e50 29%, #2c3e50 30%,
                                #3498db 30%, #3498db 31%,
                                #2980b9 31%, #2980b9 32%,
                                #1abc9c 32%, #1abc9c 33%,
                                #16a085 33%, #16a085 34%,
                                #e74c3c 34%, #e74c3c 35%,
                                #c0392b 35%, #c0392b 36%,
                                #f1c40f 36%, #f1c40f 37%,
                                #f39c12 37%, #f39c12 38%,
                                #e67e22 38%, #e67e22 39%,
                                #d35400 39%, #d35400 40%,
                                #9b59b6 40%, #9b59b6 41%,
                                #8e44ad 41%, #8e44ad 42%,
                                #34495e 42%, #34495e 43%,
                                #2c3e50 43%, #2c3e50 44%,
                                #3498db 44%, #3498db 45%,
                                #2980b9 45%, #2980b9 46%,
                                #1abc9c 46%, #1abc9c 47%,
                                #16a085 47%, #16a085 48%,
                                #e74c3c 48%, #e74c3c 49%,
                                #c0392b 49%, #c0392b 50%,
                                #f1c40f 50%, #f1c40f 51%,
                                #f39c12 51%, #f39c12 52%,
                                #e67e22 52%, #e67e22 53%,
                                #d35400 53%, #d35400 54%,
                                #9b59b6 54%, #9b59b6 55%,
                                #8e44ad 55%, #8e44ad 56%,
                                #34495e 56%, #34495e 57%,
                                #2c3e50 57%, #2c3e50 58%,
                                #3498db 58%, #3498db 59%,
                                #2980b9 59%, #2980b9 60%,
                                #1abc9c 60%, #1abc9c 61%,
                                #16a085 61%, #16a085 62%,
                                #e74c3c 62%, #e74c3c 63%,
                                #c0392b 63%, #c0392b 64%,
                                #f1c40f 64%, #f1c40f 65%,
                                #f39c12 65%, #f39c12 66%,
                                #e67e22 66%, #e67e22 67%,
                                #d35400 67%, #d35400 68%,
                                #9b59b6 68%, #9b59b6 69%,
                                #8e44ad 69%, #8e44ad 70%,
                                #34495e 70%, #34495e 71%,
                                #2c3e50 71%, #2c3e50 72%,
                                #3498db 72%, #3498db 73%,
                                #2980b9 73%, #2980b9 74%,
                                #1abc9c 74%, #1abc9c 75%,
                                #16a085 75%, #16a085 76%,
                                #e74c3c 76%, #e74c3c 77%,
                                #c0392b 77%, #c0392b 78%,
                                #f1c40f 78%, #f1c40f 79%,
                                #f39c12 79%, #f39c12 80%,
                                #e67e22 80%, #e67e22 81%,
                                #d35400 81%, #d35400 82%,
                                #9b59b6 82%, #9b59b6 83%,
                                #8e44ad 83%, #8e44ad 84%,
                                #34495e 84%, #34495e 85%,
                                #2c3e50 85%, #2c3e50 86%,
                                #3498db 86%, #3498db 87%,
                                #2980b9 87%, #2980b9 88%,
                                #1abc9c 88%, #1abc9c 89%,
                                #16a085 89%, #16a085 90%,
                                #e74c3c 90%, #e74c3c 91%,
                                #c0392b 91%, #c0392b 92%,
                                #f1c40f 92%, #f1c40f 93%,
                                #f39c12 93%, #f39c12 94%,
                                #e67e22 94%, #e67e22 95%,
                                #d35400 95%, #d35400 96%,
                                #9b59b6 96%, #9b59b6 97%,
                                #8e44ad 97%, #8e44ad 98%,
                                #34495e 98%, #34495e 99%,
                                #2c3e50 99%, #2c3e50 100%
                            );">
                        </div>
                        <!-- Playback marker -->
                        <div id="playback-marker"
                            style="position: absolute; top: 0; bottom: 0; width: 2px; background: #f39c12; left: 0%; pointer-events: none; z-index: 100;">
                        </div>
                        <!-- Analyze button overlay -->
                        <div class="analyze-overlay">
                            <button class="analyze-btn" onclick="analyzeWaveform(event)">Analyze</button>
                        </div>
                    </div>
                </div>

                <div class="track-layer" id="evidence-recording">
                    <div class="track-info">
                        <span style="font-size: 0.8em; color: #95a5a6;">Layer 1</span><br>
                        <span style="font-weight: bold; color: #ecf0f1;">Evidence_Recording</span>
                    </div>
                    <div class="track-content"
                        style="background: linear-gradient(90deg, #555 0%, #555 100%); position: relative;"
                        onclick="selectClip(event)">
                        <div class="audio-clip" data-clip="initial_scream"
                            style="left: 15%; width: 15%; height: 18px; top: 6px;" title="Initial scream">initial_scream
                        </div>
                        <div class="audio-clip" data-clip="struggle_sounds"
                            style="left: 45%; width: 20%; height: 18px; top: 6px;" title="Struggle sounds">
                            struggle_sounds</div>
                        <div class="audio-clip" data-clip="last_words"
                            style="left: 80%; width: 15%; height: 18px; top: 6px;" title="Last words">last_words</div>
                    </div>

                </div>

                <div class="track-layer" id="ghost-voices">
                    <div class="track-info">
                        <span style="font-size: 0.8em; color: #95a5a6;">Layer 2</span><br>
                        <span style="font-weight: bold; color: #ecf0f1;">Ghost_Voices</span>
                    </div>
                    <div class="track-content"
                        style="background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%); position: relative;"
                        onclick="selectClip(event)">
                        <div class="audio-clip" data-clip="whisper_1"
                            style="left: 20%; width: 10%; height: 18px; top: 6px;" title="Second whisper">whisper_1
                        </div>
                        <div class="audio-clip" data-clip="whisper_2"
                            style="left: 35%; width: 10%; height: 18px; top: 6px;" title="Third whisper">whisper_2</div>
                        <div class="audio-clip" data-clip="whisper_3"
                            style="left: 55%; width: 7%; height: 18px; top: 6px;" title="Fourth whisper">whisper_3</div>
                        <div class="audio-clip" data-clip="whisper_4"
                            style="left: 70%; width: 9%; height: 18px; top: 6px;" title="Fifth whisper">whisper_4</div>
                    </div>

                </div>

                <div class="track-layer" id="investigation">
                    <div class="track-info">
                        <span style="font-size: 0.8em; color: #95a5a6;">Layer 3</span><br>
                        <span style="font-weight: bold; color: #ecf0f1;">Investigation_Notes</span>
                    </div>
                    <div class="track-content"
                        style="background: linear-gradient(90deg, #34495e 0%, #34495e 100%); position: relative;"
                        onclick="selectClip(event)">
                        <div class="audio-clip" data-clip="police_report"
                            style="left: 40%; width: 15%; height: 18px; top: 6px;" title="Police recording">
                            police_report</div>
                        <div class="audio-clip" data-clip="witness_statement"
                            style="left: 70%; width: 20%; height: 18px; top: 6px;" title="Witness statement">
                            witness_statement</div>
                    </div>

                </div>

                <div class="track-layer" id="ambient-static-wave">
                    <div class="track-info">
                        <span style="font-size: 0.8em; color: #95a5a6;">Layer 4</span><br>
                        <span style="font-weight: bold; color: #ecf0f1;">Ambient_Static</span>
                    </div>
                    <div class="track-content"
                        style="background: linear-gradient(90deg, #1a1a1a 0%, #1a1a1a 100%); position: relative;"
                        onclick="selectClip(event)">
                        <div class="audio-clip" data-clip="room_tone"
                            style="left: 10%; width: 20%; height: 18px; top: 6px;" title="Room tone">room_tone</div>
                        <div class="audio-clip" data-clip="static_burst"
                            style="left: 35%; width: 20%; height: 18px; top: 6px;" title="Static burst">static_burst
                        </div>
                        <div class="audio-clip" data-clip="tape_hiss"
                            style="left: 70%; width: 25%; height: 18px; top: 6px;" title="Tape hiss">tape_hiss</div>
                    </div>

                </div>
            </div>

            <div class="right-panel">
                <div class="tools-header">Tools</div>
                <div id="tools-message" class="tools-message">Completely analyze the track to enable tools.</div>
                <div id="selected-clip-display" class="selected-clip-display" style="display: none;">
                    <div class="selected-clip-title">Selected Clip:</div>
                    <div class="selected-clip-name"></div>
                    <div class="selected-clip-controls">
                        <button class="selected-clip-play-btn" onclick="toggleClipPlayback(event)">‚ñ∂</button>
                        <button class="selected-clip-stop-btn" onclick="stopClipPlayback(event)">‚èπ</button>
                        <span class="selected-clip-time">00:00.000</span>
                    </div>
                    <div class="selected-clip-waveform"></div>
                </div>
                <div id="tools-container" class="tools-container" style="display: none;">
                    <div class="plugin-section disabled" onclick="selectPlugin('mute')">
                        <div class="plugin-title">üîá Mute</div>
                        <div style="font-size: 11px; color: #888;">Toggle clip muting</div>
                        <div class="checkbox"></div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('noise')">
                        <div class="plugin-title">üå´ Noise Reduction</div>
                        <div style="font-size: 11px; color: #888;">Remove noise/reverb/echo</div>
                        <div class="checkbox"></div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('voice')">
                        <div class="plugin-title">üé§ Voice Boost</div>
                        <div style="font-size: 11px; color: #888;">Enhance voice clarity</div>
                        <div class="checkbox"></div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('reverse')">
                        <div class="plugin-title">‚Üî Reverse</div>
                        <div style="font-size: 11px; color: #888;">Reverse audio playback</div>
                        <div class="checkbox"></div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('stereo')">
                        <div class="plugin-title">üéß Stereo/Mono</div>
                        <div style="font-size: 11px; color: #888;">Toggle stereo/mono mode</div>
                        <div class="checkbox"></div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('volume')">
                        <div class="plugin-title">üîä Volume</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Mute</span>
                                <span>Max</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">Adjust volume levels</div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('pitch')">
                        <div class="plugin-title">üéµ Pitch</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Lower</span>
                                <span>Higher</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">Modify pitch</div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('speed')">
                        <div class="plugin-title">‚ö° Speed</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Faster</span>
                                <span>Slower</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">Adjust playback speed</div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('highpass')">
                        <div class="plugin-title">üìà High Pass</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Low</span>
                                <span>High</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">High frequency cut-off</div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('lowpass')">
                        <div class="plugin-title">üìâ Low Pass</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Low</span>
                                <span>High</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">Low frequency cut-off</div>
                    </div>

                    <div class="plugin-section disabled" onclick="selectPlugin('bitrate')">
                        <div class="plugin-title">üíæ Bit Rate</div>
                        <div class="slider-container">
                            <div class="slider-labels">
                                <span>Low</span>
                                <span>High</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill"></div>
                                <div class="slider-thumb"></div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888;">Adjust audio quality</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedPlugin = null;
        let selectedClip = null;
        let draggedClip = null;
        let remainingClips = [];
        let currentAnalysisClip = null;
        let discoveredClips = new Set();
        let isAnalyzed = false;
        let isDrawing = false;
        let selectionBox = null;
        let startX = 0;
        let startY = 0;
        let clipPlaybackInterval = null;
        let clipStartTime = 0;
        let clipDuration = 0;
        let isClipPlaying = false;

        // Add data structure to track effects per clip
        const clipEffects = new Map(); // Maps clip ID to Set of active effects

        // Playback state
        let isPlaying = false;
        let currentTime = 0;
        let totalDuration = 47; // Total duration in seconds
        let playbackInterval;
        let playbackSpeed = 1; // Normal speed

        // Format time as MM:SS.mmm
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            const milliseconds = Math.floor((seconds % 1) * 1000);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        // Update time display
        function updateTimeDisplay() {
            const timeDisplay = document.querySelector('.time-display');
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(totalDuration)}`;
        }

        // Update playback marker position
        function updatePlaybackMarker() {
            const marker = document.getElementById('playback-marker');
            const percentage = (currentTime / totalDuration) * 100;
            marker.style.left = `${percentage}%`;
        }

        // Toggle playback
        function toggleMainPlayback(event) {
            event.stopPropagation();
            isPlaying = !isPlaying;

            // Update button icon
            const playBtn = event.target;
            playBtn.textContent = isPlaying ? '‚è∏' : '‚ñ∂';

            if (isPlaying) {
                // Start playback
                playbackInterval = setInterval(() => {
                    currentTime += 0.1 * playbackSpeed;
                    if (currentTime >= totalDuration) {
                        stopMainPlayback(event);
                        return;
                    }
                    updateTimeDisplay();
                    updatePlaybackMarker();
                }, 100);
            } else {
                // Pause playback
                clearInterval(playbackInterval);
            }
        }

        // Stop playback
        function stopMainPlayback(event) {
            event.stopPropagation();
            isPlaying = false;
            clearInterval(playbackInterval);
            currentTime = 0;
            updateTimeDisplay();
            updatePlaybackMarker();

            // Reset play button icon
            const playBtn = document.querySelector('.transport-controls .transport-btn:first-child');
            playBtn.textContent = '‚ñ∂';
        }

        // Seek to start
        function seekToStart(event) {
            event.stopPropagation();
            currentTime = 0;
            updateTimeDisplay();
            updatePlaybackMarker();
        }

        // Seek to end
        function seekToEnd(event) {
            event.stopPropagation();
            currentTime = totalDuration;
            updateTimeDisplay();
            updatePlaybackMarker();
        }

        // Add new function for auto-analysis
        function autoAnalyzeAll() {
            console.log('Auto-analyzing all clips');
            // Remove analyze button if it exists
            const analyzeOverlay = document.querySelector('.analyze-overlay');
            if (analyzeOverlay) {
                analyzeOverlay.remove();
            }

            // Collect all clips from layers 1-4
            const layers = ['evidence-recording', 'ghost-voices', 'investigation', 'ambient-static-wave'];
            const layerBaseHeights = {
                'evidence-recording': 30,
                'ghost-voices': 90,
                'investigation': 150,
                'ambient-static-wave': 210
            };

            // Show all layers and add clips to merged view
            layers.forEach(layerId => {
                const layer = document.getElementById(layerId);
                if (layer) {
                    layer.style.display = 'flex';
                    // Show all clips in the layer
                    const clips = layer.querySelectorAll('.audio-clip');
                    clips.forEach(clip => {
                        clip.style.display = 'flex';
                        discoveredClips.add(clip.dataset.clip);

                        // Add clip to merged view
                        const mergedClip = document.createElement('div');
                        mergedClip.className = 'audio-clip revealed';
                        mergedClip.dataset.clip = clip.dataset.clip;
                        mergedClip.dataset.layer = layerId;
                        mergedClip.style.left = clip.style.left;
                        mergedClip.style.width = clip.style.width;

                        // Create a hash of the clip ID to get a consistent but varied position
                        const clipHash = clip.dataset.clip.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                        const verticalVariation = (clipHash % 30) - 15; // -15 to +15 pixels variation

                        mergedClip.style.top = `${layerBaseHeights[layerId] + verticalVariation}px`;
                        mergedClip.textContent = clip.dataset.clip;

                        const mergedTrack = document.querySelector('#merged .track-content');
                        if (mergedTrack) {
                            mergedTrack.appendChild(mergedClip);
                        }
                    });
                }
            });

            // Enable tools
            enableTools();
        }

        // Initialize the analysis minigame
        function initAnalysisGame() {
            console.log('Initializing game');
            // Collect all clips from layers 1-4
            remainingClips = [];
            const layers = ['evidence-recording', 'ghost-voices', 'investigation', 'ambient-static-wave'];

            layers.forEach(layerId => {
                const layer = document.getElementById(layerId);
                console.log('Checking layer:', layerId, layer);
                if (!layer) {
                    console.error('Layer not found:', layerId);
                    return;
                }
                const clips = layer.querySelectorAll('.audio-clip');
                console.log('Found clips:', clips.length);
                // Hide all clips initially
                clips.forEach(clip => {
                    clip.style.display = 'none';
                    remainingClips.push({
                        id: clip.dataset.clip,
                        layer: layerId,
                        left: clip.style.left,
                        width: clip.style.width,
                        background: clip.style.background
                    });
                });
            });

            console.log('Total clips collected:', remainingClips.length);

            // Hide all layers except merged
            layers.forEach(layerId => {
                const layer = document.getElementById(layerId);
                if (layer) {
                    layer.style.display = 'none';
                }
            });

            // Show first random clip
            showNextAnalysisClip();

            // Add mouse event listeners for selection box
            const trackContent = document.querySelector('#waveedit #merged .track-content');
            if (trackContent) {
                trackContent.addEventListener('mousedown', startSelection);
                trackContent.addEventListener('mousemove', updateSelection);
                trackContent.addEventListener('mouseup', endSelection);
            }
        }

        function startSelection(event) {
            if (!currentAnalysisClip) return;

            // Clean up any existing selection boxes first
            const existingBoxes = event.target.querySelectorAll('.selection-box');
            existingBoxes.forEach(box => box.remove());

            isDrawing = true;
            const trackContent = event.target;
            const rect = trackContent.getBoundingClientRect();

            // Calculate position relative to track content
            startX = event.clientX - rect.left;
            startY = event.clientY - rect.top;

            // Create selection box
            selectionBox = document.createElement('div');
            selectionBox.className = 'selection-box';
            trackContent.appendChild(selectionBox);
        }

        function updateSelection(event) {
            if (!isDrawing || !selectionBox) return;

            const trackContent = event.target;
            const rect = trackContent.getBoundingClientRect();

            // Calculate current position relative to track content
            const currentX = event.clientX - rect.left;
            const currentY = event.clientY - rect.top;

            // Calculate width and height, capped at 200px
            let width = Math.abs(currentX - startX);
            let height = Math.abs(currentY - startY);

            // Cap dimensions at 200px
            width = Math.min(width, 300);
            height = Math.min(height, 150);

            // Update selection box position and size
            selectionBox.style.left = Math.min(startX, currentX) + 'px';
            selectionBox.style.top = Math.min(startY, currentY) + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
        }

        function endSelection(event) {
            if (!isDrawing || !selectionBox || !currentAnalysisClip) return;

            const width = parseInt(selectionBox.style.width);
            const height = parseInt(selectionBox.style.height);

            // Check if selection contains the clip
            const clipRect = currentAnalysisClip.getBoundingClientRect();
            const selectionRect = selectionBox.getBoundingClientRect();

            const isSelectionValid = selectionRect.left <= clipRect.left &&
                selectionRect.right >= clipRect.right &&
                selectionRect.top <= clipRect.top &&
                selectionRect.bottom >= clipRect.bottom;

            if (isSelectionValid) {
                revealClip(currentAnalysisClip);
            }

            // Clean up
            if (selectionBox && selectionBox.parentNode) {
                selectionBox.remove();
            }
            selectionBox = null;
            isDrawing = false;
        }

        // Add cleanup on mouse leave
        document.querySelector('#waveedit #merged .track-content').addEventListener('mouseleave', function () {
            if (selectionBox && selectionBox.parentNode) {
                selectionBox.remove();
            }
            selectionBox = null;
            isDrawing = false;
        });

        function revealClip(clip) {
            const clipData = remainingClips.find(c => c.id === clip.dataset.clip);
            if (!clipData) return;

            // Reveal the clip
            clip.classList.add('revealed');
            clip.style.background = clipData.background;
            clip.style.color = 'white';
            clip.style.borderColor = '#f39c12';
            clip.textContent = clipData.id;

            // Create a copy of the clip for the merged view
            const mergedClip = document.createElement('div');
            mergedClip.className = 'audio-clip revealed';
            mergedClip.dataset.clip = clipData.id;
            mergedClip.dataset.layer = clipData.layer;
            mergedClip.style.left = clipData.left;
            mergedClip.style.width = clipData.width;
            mergedClip.textContent = clipData.id;

            // Calculate vertical position based on layer and clip ID
            const layerBaseHeights = {
                'evidence-recording': 30,
                'ghost-voices': 90,
                'investigation': 150,
                'ambient-static-wave': 210
            };

            // Create a hash of the clip ID to get a consistent but varied position
            const clipHash = clipData.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const verticalVariation = (clipHash % 30) - 15; // -15 to +15 pixels variation

            mergedClip.style.top = `${layerBaseHeights[clipData.layer] + verticalVariation}px`;

            // Add the clip to the merged view
            const mergedTrack = document.querySelector('#merged .track-content');
            if (mergedTrack) {
                mergedTrack.appendChild(mergedClip);
            }

            // Show the layer and clip after a short delay
            setTimeout(() => {
                const layer = document.getElementById(clipData.layer);
                if (layer) {
                    layer.style.display = 'flex';
                    const targetClip = layer.querySelector(`.audio-clip[data-clip="${clipData.id}"]`);
                    if (targetClip) {
                        targetClip.style.display = 'flex';
                        discoveredClips.add(clipData.id);
                    }
                }

                // Remove from remaining clips
                remainingClips = remainingClips.filter(c => c.id !== clipData.id);

                // Remove analysis clip
                clip.remove();
                currentAnalysisClip = null;

                // Show next clip
                showNextAnalysisClip();

                // If all clips are discovered, enable tools
                if (remainingClips.length === 0) {
                    enableTools();
                }
            }, 500);
        }

        function showNextAnalysisClip() {
            console.log('Showing next clip, remaining:', remainingClips.length);
            if (remainingClips.length === 0) {
                console.log('No more clips to show');
                return;
            }

            // Remove previous analysis clip if exists
            if (currentAnalysisClip) {
                currentAnalysisClip.remove();
            }

            // Get random clip
            const randomIndex = Math.floor(Math.random() * remainingClips.length);
            const clipData = remainingClips[randomIndex];
            console.log('Selected clip:', clipData);

            // Create analysis clip
            const clip = document.createElement('div');
            clip.className = 'analysis-clip';
            clip.textContent = '???';
            clip.style.left = clipData.left;
            clip.style.width = clipData.width;
            clip.dataset.layer = clipData.layer;
            clip.dataset.clip = clipData.id;

            // Calculate vertical position based on layer and clip ID
            const layerBaseHeights = {
                'evidence-recording': 30,
                'ghost-voices': 90,
                'investigation': 150,
                'ambient-static-wave': 210
            };

            // Create a hash of the clip ID to get a consistent but varied position
            const clipHash = clipData.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const verticalVariation = (clipHash % 30) - 15; // -15 to +15 pixels variation

            clip.style.top = `${layerBaseHeights[clipData.layer] + verticalVariation}px`;

            // Add to merged track
            const trackContent = document.querySelector('#waveedit #merged .track-content');
            console.log('Adding clip to track:', trackContent);
            if (trackContent) {
                trackContent.appendChild(clip);
                currentAnalysisClip = clip;
            } else {
                console.error('Track content not found');
            }
        }

        function selectPlugin(pluginName) {
            if (!selectedClip || !isAnalyzed) return;

            const pluginSection = event.target.closest('.plugin-section');
            const isActive = pluginSection.classList.contains('active');
            const clipId = selectedClip.dataset.clip;

            // Initialize effects set for this clip if it doesn't exist
            if (!clipEffects.has(clipId)) {
                clipEffects.set(clipId, new Set());
            }

            const clipEffectSet = clipEffects.get(clipId);

            // Handle mute specifically
            if (pluginName === 'mute') {
                if (isActive) {
                    selectedClip.classList.remove('disabled');
                    clipEffectSet.delete(pluginName);
                } else {
                    selectedClip.classList.add('disabled');
                    clipEffectSet.add(pluginName);
                }
            } else {
                // Toggle effect in our data structure
                if (isActive) {
                    clipEffectSet.delete(pluginName);
                } else {
                    clipEffectSet.add(pluginName);
                }
            }

            // Toggle active state
            pluginSection.classList.toggle('active');

            // Toggle effect on clip
            const effectClass = `clip-${pluginName}`;
            selectedClip.classList.toggle(effectClass);

            // Update effect icons
            updateClipEffects(selectedClip);

            // Also update the clip in the merged view if it exists
            const mergedClip = document.querySelector(`#merged .audio-clip[data-clip="${clipId}"]`);
            if (mergedClip) {
                mergedClip.classList.toggle(effectClass);
            }
        }

        function updateClipEffects(clip) {
            // Remove all existing effect icons
            clip.querySelectorAll('.clip-effect').forEach(icon => icon.remove());

            const clipId = clip.dataset.clip;
            const activeEffects = clipEffects.get(clipId) || new Set();

            // Add icons for each active effect
            const effects = {
                'mute': 'üîá',
                'noise': 'üå´',
                'voice': 'üé§',
                'reverse': '‚Üî',
                'stereo': 'üéß',
                'volume': 'üîä',
                'pitch': 'üéµ',
                'speed': '‚ö°',
                'highpass': 'üìà',
                'lowpass': 'üìâ',
                'bitrate': 'üíæ'
            };

            let index = 0;
            for (const [effectName, icon] of Object.entries(effects)) {
                if (activeEffects.has(effectName)) {
                    const effectIcon = document.createElement('div');
                    effectIcon.className = 'clip-effect';
                    effectIcon.textContent = icon;
                    effectIcon.style.left = `${2 + (index * 12)}px`;
                    clip.appendChild(effectIcon);
                    index++;
                }
            }
        }

        function analyzeWaveform(event) {
            event.stopPropagation();
            console.log('Analyze button clicked');
            // Remove analyze button
            event.target.closest('.analyze-overlay').remove();
            // Start the game
            initAnalysisGame();
        }

        // AUDIO CONTROL FUNCTIONS
        function toggleTrackMute(trackId) {
            const track = document.getElementById(trackId);
            if (!track) return;

            track.classList.toggle('track-muted');

            // Update mute button
            const muteBtn = track.querySelector('.audio-control[onclick*="toggleTrackMute"]');
            if (muteBtn) {
                if (track.classList.contains('track-muted')) {
                    muteBtn.textContent = 'üîá';
                    muteBtn.classList.add('muted');
                } else {
                    muteBtn.textContent = 'üîä';
                    muteBtn.classList.remove('muted');
                }
            }
        }

        function toggleTrackSolo(trackId) {
            const track = document.getElementById(trackId);
            if (!track) return;

            track.classList.toggle('track-soloed');

            // Update solo button
            const soloBtn = track.querySelector('.audio-control[onclick*="toggleTrackSolo"]');
            if (soloBtn) {
                if (track.classList.contains('track-soloed')) {
                    soloBtn.textContent = 'üéØ';
                    soloBtn.classList.add('soloed');
                } else {
                    soloBtn.textContent = 'S';
                    soloBtn.classList.remove('soloed');
                }
            }
        }

        function toggleTrackExpansion(trackId) {
            const track = document.getElementById(trackId);
            if (!track) return;

            track.classList.toggle('track-stereo');

            // Update expansion button
            const expandBtn = track.querySelector('.audio-control[onclick*="toggleTrackExpansion"]');
            if (expandBtn) {
                if (track.classList.contains('track-stereo')) {
                    expandBtn.textContent = '‚ñº';
                } else {
                    expandBtn.textContent = '‚ñ∫';
                }
            }
        }

        // Prevent default drag behavior on document
        document.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function (e) {
            e.preventDefault();
        });

        function enableTools() {
            isAnalyzed = true;
            document.getElementById('tools-message').textContent = 'Select a clip in a layer to use tools.';
            document.getElementById('tools-container').style.display = 'block';

            // Make all clips clickable
            document.querySelectorAll('.audio-clip').forEach(clip => {
                clip.style.pointerEvents = 'auto';
                clip.style.cursor = 'pointer';
            });
        }

        function selectClip(event) {
            if (!event.target.classList.contains('audio-clip')) return;
            if (!isAnalyzed) return; // Don't allow selection before analysis

            event.stopPropagation();

            // Remove selection from all clips
            document.querySelectorAll('.audio-clip').forEach(clip => {
                clip.classList.remove('selected');
            });

            // Select clicked clip
            event.target.classList.add('selected');
            selectedClip = event.target;

            // Update selected clip display
            const selectedClipDisplay = document.getElementById('selected-clip-display');
            const selectedClipName = selectedClipDisplay.querySelector('.selected-clip-name');
            const selectedClipWaveform = selectedClipDisplay.querySelector('.selected-clip-waveform');

            // Set clip name and style
            selectedClipName.textContent = selectedClip.dataset.clip;
            selectedClipWaveform.style.background = selectedClip.style.background;

            // Show the display and hide the tools message
            selectedClipDisplay.style.display = 'block';
            document.getElementById('tools-message').style.display = 'none';

            // Enable tools and update their active state based on clip effects
            const clipId = selectedClip.dataset.clip;
            const activeEffects = clipEffects.get(clipId) || new Set();

            document.querySelectorAll('.plugin-section').forEach(section => {
                section.classList.remove('disabled');
                // Get the plugin name from the title, removing emoji and spaces
                const pluginName = section.querySelector('.plugin-title').textContent
                    .replace(/[^\w\s]/g, '') // Remove emojis
                    .trim()
                    .toLowerCase()
                    .replace(/\s+/g, ''); // Remove spaces

                // Toggle active state based on whether this effect is in the clip's active effects
                section.classList.toggle('active', activeEffects.has(pluginName));
            });
        }

        function deselectClip() {
            if (selectedClip) {
                selectedClip.classList.remove('selected');
                selectedClip = null;

                // Stop any playing clip
                if (clipPlaybackInterval) {
                    clearInterval(clipPlaybackInterval);
                    clipPlaybackInterval = null;
                }
                isClipPlaying = false;

                // Hide selected clip display and show tools message
                document.getElementById('selected-clip-display').style.display = 'none';
                const toolsMessage = document.getElementById('tools-message');
                toolsMessage.style.display = 'block';
                toolsMessage.textContent = 'Select a clip to use tools';

                // Disable tools and reset their appearance
                document.querySelectorAll('.plugin-section').forEach(section => {
                    section.classList.add('disabled');
                    section.classList.remove('active'); // Remove active state to reset color
                });
            }
        }

        // Add click handler to track content to deselect clips
        document.querySelectorAll('.track-content').forEach(track => {
            track.addEventListener('click', function (event) {
                if (event.target === this) { // Only if clicking the track itself, not a clip
                    deselectClip();
                }
            });
        });

        // Add click handler to document to deselect when clicking outside
        document.addEventListener('click', function (event) {
            // Don't deselect if clicking on tools panel or its buttons
            if (event.target.closest('.right-panel')) {
                return;
            }

            // Check if click is outside of any track content
            if (!event.target.closest('.track-content')) {
                deselectClip();
            }
        });

        // Initially disable all clips
        document.querySelectorAll('.audio-clip').forEach(clip => {
            clip.style.pointerEvents = 'none';
            clip.style.cursor = 'default';
        });

        // Add slider functionality
        function initSliders() {
            document.querySelectorAll('.slider-track').forEach(track => {
                const thumb = track.querySelector('.slider-thumb');
                const fill = track.querySelector('.slider-fill');
                let isDragging = false;

                function updateSlider(e) {
                    const rect = track.getBoundingClientRect();
                    const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                    const percent = (x / rect.width) * 100;

                    fill.style.width = `${percent}%`;
                    thumb.style.left = `${percent}%`;

                    // Handle speed slider specifically
                    if (track.closest('.plugin-section').querySelector('.plugin-title').textContent.includes('Speed')) {
                        const clip = document.querySelector('.audio-clip.selected');
                        if (clip) {
                            // Calculate new width based on slider value
                            // 50% = normal speed, 0% = half speed, 100% = double speed
                            const originalWidth = parseFloat(clip.dataset.originalWidth || clip.style.width);
                            const speedFactor = 1 + (percent - 50) / 50; // 0.5 to 1.5
                            clip.style.width = `${originalWidth * speedFactor}%`;
                        }
                    }
                }

                thumb.addEventListener('mousedown', () => {
                    isDragging = true;
                    // Store original width when starting to drag speed slider
                    if (track.closest('.plugin-section').querySelector('.plugin-title').textContent.includes('Speed')) {
                        const clip = document.querySelector('.audio-clip.selected');
                        if (clip && !clip.dataset.originalWidth) {
                            clip.dataset.originalWidth = clip.style.width;
                        }
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        updateSlider(e);
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                track.addEventListener('click', (e) => {
                    updateSlider(e);
                });
            });
        }

        // Call initSliders after the page loads
        window.addEventListener('load', initSliders);

        function stopClipPlayback(event) {
            event.stopPropagation();
            const playBtn = event.target.parentElement.querySelector('.selected-clip-play-btn');
            const timeDisplay = event.target.parentElement.querySelector('.selected-clip-time');

            // Stop playback
            if (clipPlaybackInterval) {
                clearInterval(clipPlaybackInterval);
                clipPlaybackInterval = null;
            }

            // Reset UI
            playBtn.textContent = '‚ñ∂';
            timeDisplay.textContent = '00:00.000';
            isClipPlaying = false;
        }

        function toggleClipPlayback(event) {
            event.stopPropagation();
            const playBtn = event.target;
            const timeDisplay = playBtn.parentElement.querySelector('.selected-clip-time');

            if (isClipPlaying) {
                // Stop playback
                clearInterval(clipPlaybackInterval);
                playBtn.textContent = '‚ñ∂';
                isClipPlaying = false;
            } else {
                // Start playback
                clipStartTime = Date.now();
                clipDuration = 5000; // 5 seconds for demo
                playBtn.textContent = '‚è∏';
                isClipPlaying = true;

                // Update time display every 50ms
                clipPlaybackInterval = setInterval(() => {
                    const elapsed = Date.now() - clipStartTime;
                    if (elapsed >= clipDuration) {
                        // Stop at end of clip
                        clearInterval(clipPlaybackInterval);
                        playBtn.textContent = '‚ñ∂';
                        timeDisplay.textContent = '00:00.000';
                        isClipPlaying = false;
                        return;
                    }

                    // Format time as MM:SS.mmm
                    const seconds = Math.floor(elapsed / 1000);
                    const milliseconds = elapsed % 1000;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
                }, 50);
            }
        }
    </script>
</body>

</html>